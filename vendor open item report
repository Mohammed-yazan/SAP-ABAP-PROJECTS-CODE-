REPORT Z_WRICEF
*VENDOR OPEN ITEM REPORT WITH PO NUMBER WISE
NO STANDARD PAGE HEADING
MESSAGE-ID : ZMSGCL.
*DECLARATIONS
TYPES: BEGIN OF TYPE1,
         BUKRS TYPE BSIK-BUKRS,
         LIFNR TYPE BSIK-LIFNR,
         NAME1 TYPE LFA1-NAME1,
         ORT01 TYPE LFA1-ORT01,
         BELNR TYPE BSIK-BELNR,
         BLART TYPE BSIK-BLART,
         BLDAT TYPE BSIK-BLDAT,
         UMSKZ TYPE BSIK-UMSKZ,
         ZTERM TYPE BSIK-ZTERM,
         ZFBDT TYPE BSIK-ZFBDT,
         DMBTR TYPE BSIK-DMBTR,
         WAERS TYPE BSIK-WAERS,
         ZUONR TYPE BSIK-ZUONR,
         PRCTR TYPE BSEG-PRCTR,
         HKONT TYPE BSIK-HKONT,
         USNAM TYPE BKPF-USNAM,
         EBELN TYPE EKBE-EBELN,
         AWKEY TYPE BKPF-AWKEY,
       END OF TYPE1.

DATA: ITAB TYPE STANDARD TABLE OF TYPE1,
      WA TYPE TYPE1.

TYPES: BEGIN OF TYPE2,
         BELNR TYPE EKBE-BELNR,
         GJAHR TYPE EKBE-GJAHR,
         ebeln type ekbe-ebeln,
       END OF TYPE2.
  DATA: ITEKBE TYPE STANDARD TABLE OF TYPE2,
        WAEKBE type type2.
*FIELDCATALOG DECLARATIONS
TYPE-POOLS : SLIS.
DATA : ITFCAT TYPE SLIS_T_FIELDCAT_ALV,
       WAFCAT TYPE SLIS_FIELDCAT_ALV.
DATA:EBUKRS TYPE BUKRS.
*SORT FOR AMOUNT
DATA: it_sort TYPE slis_t_sortinfo_alv,
      wa_sort TYPE slis_sortinfo_alv.
*INPUT
SELECTION-SCREEN BEGIN OF BLOCK B1 WITH FRAME TITLE T1.
  PARAMETERS: COMPANY TYPE BSIK-BUKRS OBLIGATORY.

DATA: V1 TYPE BSIK-LIFNR.
  SELECT-OPTIONS VENDOR FOR V1.

DATA: V2 TYPE BSIK-BUDAT.
  SELECT-OPTIONS PDATE FOR V2.
SELECTION-SCREEN END OF BLOCK B1.
INITIALIZATION.
T1 = 'Vendor Selection'.
*PROCESS
START-OF-SELECTION.
*    PERFORM SUBR_SORT.
    PERFORM SUBR_OPENSQL.

*END OF PAGE SELECTION

END-OF-SELECTION.
*OUTPUT
CASE SY-SUBRC.
  WHEN 0.
    PERFORM SUBR_FCAT.
    PERFORM SUBR_OUTPUT.
  WHEN 4.
    MESSAGE S002.
ENDCASE.
*&--------------------------*
*&      Form  SUBR_OPENSQL
*&--------------------------*
FORM SUBR_OPENSQL .
 SELECT A~BUKRS A~LIFNR B~NAME1 B~ORT01 A~BELNR A~BLART A~BLDAT A~UMSKZ A~ZTERM A~ZFBDT A~DMBTR
        A~WAERS A~ZUONR C~PRCTR A~HKONT D~USNAM INTO TABLE ITAB
        FROM BSIK AS A
        INNER JOIN
        LFA1 AS B
        ON A~LIFNR = B~LIFNR
        INNER JOIN BSEG AS C
        ON A~BUKRS = C~BUKRS
        AND A~BELNR = C~BELNR
        AND A~GJAHR = C~GJAHR
        INNER JOIN BKPF AS D
        ON A~BUKRS = D~BUKRS
        AND A~BELNR = D~BELNR
        AND A~GJAHR = D~GJAHR
        WHERE A~BUKRS EQ COMPANY AND A~LIFNR IN VENDOR AND
        A~BUDAT IN PDATE.
   IF ITAB IS INITIAL.
      MESSAGE 'DATA NOT FOUND' TYPE 'S'.
   ENDIF.

CLEAR ITEKBE.

LOOP AT itab INTO wa.
  IF wa-awkey IS NOT INITIAL.
    waekbe-belnr = wa-awkey+0(10).
    waekbe-gjahr = wa-awkey+10(4).
    APPEND waekbe TO itekbe.

  ENDIF.
ENDLOOP.

DELETE ADJACENT DUPLICATES FROM itekbe COMPARING belnr gjahr.
IF itekbe IS NOT INITIAL.

  SELECT belnr
         gjahr
         ebeln
    INTO TABLE itekbe
    FROM ekbe
    FOR ALL ENTRIES IN itekbe
    WHERE belnr = itekbe-belnr
      AND gjahr = itekbe-gjahr.

  SORT itekbe BY belnr gjahr.

ENDIF.



LOOP AT itab INTO wa.
 READ TABLE itekbe INTO waekbe
    WITH KEY
      belnr = wa-awkey+0(10)
      gjahr = wa-awkey+10(4)
    BINARY SEARCH.

  IF sy-subrc = 0.
    wa-ebeln = waekbe-ebeln.
    MODIFY itab FROM wa.
  ENDIF.
ENDLOOP.
SORT itab BY bukrs lifnr belnr.
DELETE ADJACENT DUPLICATES FROM itab
  COMPARING bukrs lifnr belnr.
ENDFORM.
*&-----------------------*
*&      Form  SUBR_FCAT
*&-----------------------*
FORM SUBR_FCAT .

WAFCAT-COL_POS = 1.
  WAFCAT-FIELDNAME = 'BUKRS'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'l'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'Company Code'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.

  WAFCAT-COL_POS = 2.
  WAFCAT-FIELDNAME = 'LIFNR'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'L'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'Vendor Number'.
  WAFCAT-EDIT_MASK  = '==ALPHA'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.

  WAFCAT-COL_POS = 3.
  WAFCAT-FIELDNAME = 'NAME1'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'L'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'Name'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.

  WAFCAT-COL_POS = 4.
  WAFCAT-FIELDNAME = 'ORT01'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'L'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'City'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.

  WAFCAT-COL_POS = 5.
  WAFCAT-FIELDNAME = 'BELNR'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'L'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'Document Number'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.

  WAFCAT-COL_POS = 6.
  WAFCAT-FIELDNAME = 'BLART'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'L'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'Document Type'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.

  WAFCAT-COL_POS = 7.
  WAFCAT-FIELDNAME = 'BLDAT'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'L'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'Document Date'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.

  WAFCAT-COL_POS = 8.
  WAFCAT-FIELDNAME = 'UMSKZ'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'L'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'Special G/L Indicator'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.

  WAFCAT-COL_POS = 9.
  WAFCAT-FIELDNAME = 'ZTERM'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'L'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'Payment Terms'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.

  WAFCAT-COL_POS = 10.
  WAFCAT-FIELDNAME = 'ZFBDT'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'L'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'Due Date'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.

  WAFCAT-COL_POS = 11.
  WAFCAT-FIELDNAME = 'DMBTR'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'L'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'Amount In Local Currency'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.

  WAFCAT-COL_POS = 12.
  WAFCAT-FIELDNAME = 'WAERS'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'L'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'Local Currency'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.

  WAFCAT-COL_POS = 13.
  WAFCAT-FIELDNAME = 'ZUONR'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'L'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'Assignment'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.

  WAFCAT-COL_POS = 14.
  WAFCAT-FIELDNAME = 'PRCTR'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'L'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'Profit Center'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.

  WAFCAT-COL_POS = 15.
  WAFCAT-FIELDNAME = 'HKONT'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'L'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'Recon G/L'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.

  WAFCAT-COL_POS = 16.
  WAFCAT-FIELDNAME = 'USNAM'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'L'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'Username'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.

  WAFCAT-COL_POS = 17.
  WAFCAT-FIELDNAME = 'EBELN'.
  WAFCAT-KEY = 'X'.
  WAFCAT-JUST = 'L'.
  WAFCAT-OUTPUTLEN = 20.
  WAFCAT-SELTEXT_M = 'Purchase Order Number'.
  APPEND WAFCAT TO ITFCAT.
  CLEAR WAFCAT.
ENDFORM.
*&-------------------------*
*&      Form  SUBR_OUTPUT
*&-------------------------*
FORM SUBR_OUTPUT .
CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
 EXPORTING
   I_CALLBACK_PROGRAM             = SY-CPROG
   I_GRID_TITLE                   = 'Vendor Report'
   IT_FIELDCAT                    = ITFCAT
   IT_SORT                        = IT_SORT
  TABLES
    T_OUTTAB                       = ITAB.
ENDFORM.
*&------------------------*
*&      Form  SUBR_SORT
*&------------------------*
FORM SUBR_SORT .
 CLEAR wa_sort.
  wa_sort-fieldname = 'LIFNR'.
  wa_sort-up        = 'X'.
  wa_sort-subtot    = 'X'.
  APPEND wa_sort TO it_sort.
ENDFORM.
